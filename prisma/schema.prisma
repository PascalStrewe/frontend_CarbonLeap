// prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                    Int                   @id @default(autoincrement())
  email                 String                @unique
  password              String
  isAdmin               Boolean               @default(false)
  domain                Domain                @relation(fields: [domainId], references: [id])
  domainId              Int
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  interventionRequests  InterventionRequest[]
  
  // **Added Relation Field for Transfers Created by User**
  createdTransfers      Transfer[]            @relation("UserCreatedTransfers")
}

model Domain {
  id                      Int                      @id @default(autoincrement())
  name                    String                   @unique
  companyName             String
  users                   User[]
  interventions           Intervention[]
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  transfersOut            Transfer[]               @relation("SourceDomain")
  transfersIn             Transfer[]               @relation("TargetDomain")
  partnershipsAsFirst     DomainPartnership[]      @relation("PartnershipDomain1")
  partnershipsAsSecond    DomainPartnership[]      @relation("PartnershipDomain2")
  notifications           Notification[]
}

model Intervention {
  id            Int          @id @default(autoincrement())
  domain        Domain       @relation(fields: [domainId], references: [id])
  domainId      Int
}

model InterventionRequest {
  id                        String    @id @default(cuid())
  userId                    Int      
  clientName                String    @default("Unknown Client")
  emissionsAbated          Float     @default(0)
  date                     DateTime   @default(now())
  interventionId           String    @unique
  modality                 String
  geography                String
  additionality            Boolean   @default(false)
  causality               Boolean    @default(false)
  status                  String
  deliveryTicketNumber    String?
  materialName            String?
  materialId              String?
  vendorName              String?
  quantity                Float?
  unit                    String?
  amount                  Float?
  materialSustainabilityStatus Boolean?
  interventionType        String?
  lowCarbonFuel          String    @default("n/a")  // biofuelProduct in frontend
  baselineFuelProduct     String?
  typeOfVehicle          String?
  feedstock              String    @default("n/a")  // typeOfFeedstock in frontend
  emissionReductionPercentage Float?
  intensityOfBaseline     String?
  intensityLowCarbonFuel  String?
  certificationScheme     String    @default("n/a") // certification in frontend
  scope                   String?
  thirdPartyVerifier     String?
  standards              String?
  
  // Existing fields
  vesselType               String?
  lowCarbonFuelLiters      String?
  lowCarbonFuelMT          String?
  scope3EmissionsAbated    String?
  ghgEmissionSaving        String
  vintage                  String
  thirdPartyVerification   String
  otherCertificationScheme String?
  notificationSent         Boolean    @default(false)
  submissionDate           DateTime   @default(now())
  reviewedAt               DateTime?
  reviewedBy               String?
  comments                 String?
  remainingAmount          String     @default("0")

  // Relations
  user                     User       @relation(fields: [userId], references: [id])
  transfersOut             Transfer[] @relation("SourceIntervention")

  @@index([status])
  @@index([clientName])
}


model Transfer {
  id                    String              @id @default(cuid())
  sourceIntervention    InterventionRequest @relation("SourceIntervention", fields: [sourceInterventionId], references: [id])
  sourceInterventionId  String
  sourceDomain          Domain              @relation("SourceDomain", fields: [sourceDomainId], references: [id])
  sourceDomainId        Int
  targetDomain          Domain              @relation("TargetDomain", fields: [targetDomainId], references: [id])
  targetDomainId        Int
  amount                Float               // Changed to Float for numeric COâ‚‚ amounts
  status                String              @default("pending") // pending, completed, cancelled
  createdAt             DateTime            @default(now())
  completedAt           DateTime?
  notes                 String?             // Removed duplicate 'notes' field
  createdBy             User                @relation("UserCreatedTransfers", fields: [createdById], references: [id])
  createdById           Int

  @@index([status])
  // Removed @@index([transferCode]) as there is no transferCode field
}

model Notification {
  id        String   @id @default(cuid())
  type      String   // TRANSFER_APPROVED, TRANSFER_REJECTED, etc.
  message   String
  domain    Domain   @relation(fields: [domainId], references: [id])
  domainId  Int
  metadata  Json?    // Additional data specific to notification type
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([domainId])
  @@index([type])
}

model DomainPartnership {
  id                Int      @id @default(autoincrement())
  domain1           Domain   @relation("PartnershipDomain1", fields: [domain1Id], references: [id])
  domain1Id         Int
  domain2           Domain   @relation("PartnershipDomain2", fields: [domain2Id], references: [id])
  domain2Id         Int
  status            String   @default("pending") // pending, active, inactive
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([domain1Id, domain2Id])
  @@index([domain1Id])
  @@index([domain2Id])
}
